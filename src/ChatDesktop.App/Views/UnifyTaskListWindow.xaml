<Window x:Class="ChatDesktop.App.Views.UnifyTaskListWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="分页任务" Height="720" Width="960" WindowStartupLocation="CenterOwner"
        Loaded="OnLoaded">
  <Grid Margin="16">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <DockPanel Grid.Row="0" LastChildFill="False">
      <StackPanel DockPanel.Dock="Left">
        <TextBlock Text="{Binding Title}" FontSize="16" FontWeight="Bold" />
        <TextBlock Text="{Binding TotalElements, StringFormat=共 {0} 条}" Foreground="#666" />
      </StackPanel>
      <Button Content="关闭" DockPanel.Dock="Right" Width="80" Click="OnCloseClicked" />
    </DockPanel>

    <Border Grid.Row="1" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="6" Padding="12" Margin="0,12,0,12">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="160" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <StackPanel Grid.Column="0">
          <TextBlock Text="类型" FontWeight="Bold" />
          <ComboBox Margin="0,6,0,0"
                    ItemsSource="{Binding TypeOptions}"
                    DisplayMemberPath="Label"
                    SelectedValuePath="Value"
                    SelectedValue="{Binding SelectedType, Mode=TwoWay}" />
        </StackPanel>

        <StackPanel Grid.Column="1" Margin="12,0,12,0">
          <TextBlock Text="搜索" FontWeight="Bold" />
          <TextBox Text="{Binding Keyword, UpdateSourceTrigger=PropertyChanged}" Margin="0,6,0,0" />
        </StackPanel>

        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Bottom">
          <Button Content="查询" Command="{Binding SearchCommand}" Margin="0,0,8,0" />
          <Button Content="刷新" Command="{Binding RefreshCommand}" />
        </StackPanel>
      </Grid>
    </Border>

    <Grid Grid.Row="2">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,8">
        <TextBlock Text="到期开始" VerticalAlignment="Center" />
        <DatePicker SelectedDate="{Binding DueStartDate, Mode=TwoWay}" Width="140" Margin="8,0,8,0" />
        <TextBox Text="{Binding DueStartTimeText}" Width="70" IsReadOnly="True" />
        <Button Content="选择" Width="50" Margin="6,0,16,0" Click="OnPickStartTime" />

        <TextBlock Text="到期结束" VerticalAlignment="Center" />
        <DatePicker SelectedDate="{Binding DueEndDate, Mode=TwoWay}" Width="140" Margin="8,0,8,0" />
        <TextBox Text="{Binding DueEndTimeText}" Width="70" IsReadOnly="True" />
        <Button Content="选择" Width="50" Margin="6,0,8,0" Click="OnPickEndTime" />
        <TextBlock Text="(HH:mm)" Foreground="#666" VerticalAlignment="Center" />
      </StackPanel>

      <Grid Grid.Row="1">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <TextBlock Text="{Binding Error}" Foreground="#C62828" Margin="0,0,0,8"
                   Visibility="{Binding Error, Converter={StaticResource StringNotEmptyToVisibilityConverter}}" />

        <ListView Grid.Row="1" ItemsSource="{Binding Tasks}">
          <ListView.ItemTemplate>
            <DataTemplate>
              <Border BorderBrush="#E5E5E5" BorderThickness="1" CornerRadius="6" Margin="0,0,0,8" Padding="10">
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="1.5*" />
                    <ColumnDefinition Width="1.2*" />
                    <ColumnDefinition Width="1.2*" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>

                  <StackPanel Grid.Column="0">
                    <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding DueDate}" Foreground="#666" />
                  </StackPanel>

                  <TextBlock Grid.Column="1" Text="{Binding AssignedTo}" Foreground="#666" TextTrimming="CharacterEllipsis" />
                  <TextBlock Grid.Column="2" Text="{Binding AssignedBy}" Foreground="#666" TextTrimming="CharacterEllipsis" />

                  <StackPanel Grid.Column="3">
                    <TextBlock Text="{Binding IsRead, StringFormat=已读: {0}}" Foreground="#666" />
                    <TextBlock Text="{Binding IsCompleted, StringFormat=完成: {0}}" Foreground="#666" />
                  </StackPanel>

                  <StackPanel Grid.Column="4" Orientation="Horizontal">
                    <Button Content="详情"
                            Command="{Binding DataContext.OpenDetailCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                            CommandParameter="{Binding}" Margin="0,0,6,0" />
                    <Button Content="已读"
                            Command="{Binding DataContext.MarkReadCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                            CommandParameter="{Binding}" Margin="0,0,6,0" />
                    <Button Content="完成"
                            Command="{Binding DataContext.CompleteCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                            CommandParameter="{Binding}" />
                  </StackPanel>
                </Grid>
              </Border>
            </DataTemplate>
          </ListView.ItemTemplate>
        </ListView>

        <TextBlock Text="加载中..." HorizontalAlignment="Center" VerticalAlignment="Center"
                   Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />
      </Grid>
    </Grid>

    <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
      <Button Content="上一页" Command="{Binding PrevCommand}" Margin="0,0,8,0" />
      <TextBlock Text="{Binding PageLabel}" VerticalAlignment="Center" Margin="0,0,8,0" />
      <Button Content="下一页" Command="{Binding NextCommand}" Margin="0,0,12,0" />
      <TextBlock Text="每页" VerticalAlignment="Center" Margin="0,0,6,0" />
      <ComboBox Width="80"
                ItemsSource="{Binding SizeOptions}"
                SelectedItem="{Binding Size, Mode=TwoWay}" />
    </StackPanel>
  </Grid>
</Window>
