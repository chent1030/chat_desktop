<Window x:Class="ChatDesktop.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:md="clr-namespace:Markdig.Wpf;assembly=Markdig.Wpf"
        Title="ChatDesktop" Height="800" Width="1200" MinHeight="600" MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Loaded="OnLoaded">
  <Grid>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="340" />
      <ColumnDefinition Width="*" />
    </Grid.ColumnDefinitions>

    <!-- 任务列表 -->
    <Grid Grid.Column="0">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <Border Background="#F7F7F7" Padding="12" Grid.Row="0">
        <DockPanel LastChildFill="True">
          <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
            <TextBlock Text="待办事项" FontSize="16" FontWeight="Bold" VerticalAlignment="Center" />
          </StackPanel>

          <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" DockPanel.Dock="Right" Margin="12,0,0,0">
            <Button Content="新建任务" Command="{Binding TaskList.OpenCreateCommand}" Margin="0,0,8,0" />
            <Button Content="语音创建" Command="{Binding TaskList.OpenVoiceCreateCommand}" Margin="0,0,8,0" />
            <Button Content="分页任务" Command="{Binding TaskList.OpenPagedCommand}" Margin="0,0,8,0" />
            <Button Content="刷新" Command="{Binding TaskList.RefreshCommand}" Margin="0,0,8,0" />
            <Button Content="清空搜索" Command="{Binding TaskList.ClearSearchCommand}" Margin="0,0,8,0" />
            <Button Content="清除已完成" Command="{Binding TaskList.ClearCompletedCommand}" Margin="0,0,8,0" />
            <Button Content="修改工号" Command="{Binding TaskList.OpenChangeEmpNoCommand}" />
          </StackPanel>
        </DockPanel>
      </Border>

      <Border Background="#FFFFFF" Padding="12" Grid.Row="1">
        <StackPanel>
          <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
            <ComboBox Width="140"
                      ItemsSource="{Binding TaskList.FilterOptions}"
                      DisplayMemberPath="Label"
                      SelectedValuePath="Value"
                      SelectedValue="{Binding TaskList.SelectedFilter, Mode=TwoWay}" />
            <ComboBox Width="160" Margin="8,0,0,0"
                      ItemsSource="{Binding TaskList.SortOptions}"
                      DisplayMemberPath="Label"
                      SelectedValuePath="Value"
                      SelectedValue="{Binding TaskList.SelectedSort, Mode=TwoWay}" />
          </StackPanel>
          <TextBox Margin="0,8,0,0"
                   Text="{Binding TaskList.SearchKeyword, UpdateSourceTrigger=PropertyChanged}" />
        </StackPanel>
      </Border>

      <Border Background="#FFFFFF" Padding="12" Grid.Row="2">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Grid.Row="0">
            <TextBlock Text="总数: " />
            <TextBlock Text="{Binding TaskList.Statistics.Total}" FontWeight="Bold" Margin="0,0,16,0" />
            <TextBlock Text="未完成: " />
            <TextBlock Text="{Binding TaskList.Statistics.Incomplete}" FontWeight="Bold" Margin="0,0,16,0" />
            <TextBlock Text="已完成: " />
            <TextBlock Text="{Binding TaskList.Statistics.Completed}" FontWeight="Bold" />
          </StackPanel>

          <ListView Grid.Row="1" ItemsSource="{Binding TaskList.Tasks}" Margin="0,12,0,0">
            <ListView.ItemTemplate>
              <DataTemplate>
                <Border BorderBrush="#E5E5E5" BorderThickness="1" CornerRadius="6" Margin="0,0,0,8" Padding="10">
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <CheckBox Grid.Column="0" IsChecked="{Binding IsCompleted}" VerticalAlignment="Center" Margin="0,0,8,0" />

                    <StackPanel Grid.Column="1">
                      <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                      <TextBlock Text="{Binding Description}" Foreground="#666" TextWrapping="Wrap" MaxHeight="48" />
                      <TextBlock Text="{Binding DueDate}" Foreground="#888" />
                    </StackPanel>

                    <StackPanel Grid.Column="2" VerticalAlignment="Center">
                      <Button Content="切换完成"
                              Command="{Binding DataContext.TaskList.ToggleCompletionCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                              CommandParameter="{Binding}" />
                      <Button Content="详情" Margin="0,6,0,0"
                              Command="{Binding DataContext.TaskList.OpenDetailCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                              CommandParameter="{Binding}" />
                      <Button Content="编辑" Margin="0,6,0,0"
                              Command="{Binding DataContext.TaskList.OpenEditCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                              CommandParameter="{Binding}" />
                    </StackPanel>
                  </Grid>
                </Border>
              </DataTemplate>
            </ListView.ItemTemplate>
          </ListView>
        </Grid>
      </Border>
    </Grid>

    <!-- AI 对话 -->
    <Grid Grid.Column="1" Background="#FAFAFA">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="240" />
        <ColumnDefinition Width="*" />
      </Grid.ColumnDefinitions>

      <!-- 会话列表 -->
      <Border Background="#FFFFFF" Padding="12" Grid.Column="0">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>

          <StackPanel Orientation="Horizontal" Grid.Row="0">
            <TextBlock Text="会话" FontWeight="Bold" />
            <Button Content="新建" Command="{Binding Chat.NewConversationCommand}" Margin="8,0,0,0" />
          </StackPanel>

          <TextBox Grid.Row="1" Margin="0,8,0,8"
                   Text="{Binding Chat.SelectedConversationTitle, UpdateSourceTrigger=PropertyChanged}" />

          <ListBox Grid.Row="2"
                   ItemsSource="{Binding Chat.Conversations}"
                   SelectedItem="{Binding Chat.SelectedConversation, Mode=TwoWay}">
            <ListBox.ItemTemplate>
              <DataTemplate>
                <Border Padding="8" BorderBrush="#E5E5E5" BorderThickness="0,0,0,1">
                  <TextBlock Text="{Binding Title}" />
                </Border>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>

          <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
            <Button Content="保存标题" Command="{Binding Chat.SaveTitleCommand}" Margin="0,0,8,0" />
            <Button Content="删除" Command="{Binding Chat.DeleteConversationCommand}" />
          </StackPanel>
        </Grid>
      </Border>

      <!-- 对话区 -->
      <Grid Grid.Column="1" Margin="12">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <StackPanel Orientation="Horizontal" Grid.Row="0" VerticalAlignment="Center">
          <ComboBox Width="140"
                    ItemsSource="{Binding Chat.AssistantOptions}"
                    DisplayMemberPath="Label"
                    SelectedValuePath="Value"
                    SelectedValue="{Binding Chat.AssistantKey, Mode=TwoWay}" />
          <TextBlock Text="AI 正在输出..." Margin="12,0,0,0"
                     Visibility="{Binding Chat.IsStreaming, Converter={StaticResource BooleanToVisibilityConverter}}" />
          <TextBlock Text="{Binding Chat.Error}" Foreground="#C62828" Margin="12,0,0,0"
                     Visibility="{Binding Chat.Error, Converter={StaticResource StringNotEmptyToVisibilityConverter}}" />
        </StackPanel>

        <ListBox Grid.Row="1" ItemsSource="{Binding Chat.Messages}" Background="#FAFAFA" BorderThickness="0" Margin="0,12,0,12">
          <ListBox.ItemTemplate>
            <DataTemplate>
              <Border x:Name="MessageCard" Padding="10" Margin="0,0,0,8" CornerRadius="6" Background="#FFFFFF" BorderBrush="#E5E5E5" BorderThickness="1" MaxWidth="520">
                <StackPanel>
                  <TextBlock Text="{Binding RoleLabel}" Foreground="#666" FontSize="11" />
                  <md:MarkdownViewer Markdown="{Binding Content}" Background="Transparent" />
                </StackPanel>
              </Border>
              <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding IsUser}" Value="True">
                  <Setter TargetName="MessageCard" Property="HorizontalAlignment" Value="Right" />
                  <Setter TargetName="MessageCard" Property="Background" Value="#E6F2FF" />
                  <Setter TargetName="MessageCard" Property="BorderBrush" Value="#C5D9F2" />
                </DataTrigger>
              </DataTemplate.Triggers>
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>

        <Grid Grid.Row="2">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>
          <TextBox Grid.Column="0" Height="60"
                   Text="{Binding Chat.InputText, UpdateSourceTrigger=PropertyChanged}"
                   AcceptsReturn="True" TextWrapping="Wrap" />
          <Button Grid.Column="1" Content="发送" Margin="8,0,0,0" Width="80"
                  Command="{Binding Chat.SendCommand}" />
        </Grid>
      </Grid>
    </Grid>
  </Grid>
</Window>
