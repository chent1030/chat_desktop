<Window x:Class="ChatDesktop.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:md="clr-namespace:Markdig.Wpf;assembly=Markdig.Wpf"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:coreEnums="clr-namespace:ChatDesktop.Core.Enums;assembly=ChatDesktop.Core"
        xmlns:coreModels="clr-namespace:ChatDesktop.Core.Models;assembly=ChatDesktop.Core"
        xmlns:scm="clr-namespace:System.Windows.Data;assembly=PresentationFramework"
        Title="ChatDesktop" Height="800" Width="1200" MinHeight="640" MinWidth="960"
        WindowStartupLocation="CenterScreen"
        Background="#F4F6FA"
        Loaded="OnLoaded">
  <Window.Resources>
    <Style x:Key="AssistantToggleButtonStyle" TargetType="ToggleButton">
      <Setter Property="Foreground" Value="#5C6BC0" />
      <Setter Property="Background" Value="Transparent" />
      <Setter Property="BorderBrush" Value="#C5CAE9" />
      <Setter Property="BorderThickness" Value="1" />
      <Setter Property="Padding" Value="12,6" />
      <Setter Property="FontWeight" Value="SemiBold" />
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="ToggleButton">
            <Border Background="{TemplateBinding Background}"
                    BorderBrush="{TemplateBinding BorderBrush}"
                    BorderThickness="{TemplateBinding BorderThickness}"
                    CornerRadius="8">
              <ContentPresenter HorizontalAlignment="Center"
                                VerticalAlignment="Center" />
            </Border>
            <ControlTemplate.Triggers>
              <Trigger Property="IsChecked" Value="True">
                <Setter Property="Background" Value="#5C6BC0" />
                <Setter Property="Foreground" Value="White" />
                <Setter Property="BorderBrush" Value="#5C6BC0" />
              </Trigger>
              <Trigger Property="IsEnabled" Value="False">
                <Setter Property="Opacity" Value="0.6" />
              </Trigger>
            </ControlTemplate.Triggers>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>
  </Window.Resources>
  <Grid Margin="12">
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="360" />
      <ColumnDefinition Width="*" />
    </Grid.ColumnDefinitions>

    <!-- 任务列表 -->
    <Grid Grid.Column="0">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <Border Background="White" CornerRadius="12" Padding="14" Grid.Row="0"
              BorderBrush="#E6E9F0" BorderThickness="1"
              materialDesign:ShadowAssist.ShadowDepth="Depth2">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <StackPanel>
            <TextBlock Text="待办事项" FontSize="18" FontWeight="SemiBold" />
            <TextBlock Text="任务中心" Foreground="#7A808A" FontSize="12" Margin="0,2,0,0" />
          </StackPanel>

          <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
            <Button Style="{StaticResource MaterialDesignRaisedButton}"
                    Command="{Binding TaskList.OpenCreateCommand}" Margin="0,0,8,0"
                    Padding="10,6">
              <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="Plus" Width="16" Height="16" Margin="0,0,6,0" />
                <TextBlock Text="新建任务" />
              </StackPanel>
            </Button>
            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                    Command="{Binding TaskList.OpenPagedCommand}" Margin="0,0,8,0"
                    Padding="10,6">
              <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="Table" Width="16" Height="16" Margin="0,0,6,0" />
                <TextBlock Text="分页任务" />
              </StackPanel>
            </Button>
            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                    Command="{Binding TaskList.OpenVoiceCreateCommand}" Margin="0,0,8,0"
                    Padding="10,6">
              <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="Microphone" Width="16" Height="16" Margin="0,0,6,0" />
                <TextBlock Text="语音创建" />
              </StackPanel>
            </Button>
            <Button Style="{StaticResource MaterialDesignFlatButton}" Padding="6" Margin="0,0,0,0">
              <materialDesign:PackIcon Kind="DotsVertical" Width="18" Height="18" />
              <Button.ContextMenu>
                <ContextMenu>
                  <MenuItem Header="清除已完成任务" Command="{Binding TaskList.ClearCompletedCommand}" />
                  <MenuItem Header="修改工号" Command="{Binding TaskList.OpenChangeEmpNoCommand}" />
                </ContextMenu>
              </Button.ContextMenu>
            </Button>
          </StackPanel>
        </Grid>
      </Border>

      <Border Background="#F6F8FF" CornerRadius="12" Padding="12" Grid.Row="1" Margin="0,12,0,0"
              BorderBrush="#E6E9F0" BorderThickness="1">
        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
          <StackPanel Orientation="Horizontal">
            <Ellipse Width="8" Height="8" Fill="#5C6BC0" Margin="0,0,6,0" VerticalAlignment="Center" />
            <TextBlock Text="总数" Foreground="#5C6BC0" />
            <TextBlock Text="{Binding TaskList.Statistics.Total}" FontWeight="SemiBold" Margin="6,0,14,0" />
          </StackPanel>
          <StackPanel Orientation="Horizontal">
            <Ellipse Width="8" Height="8" Fill="#FB8C00" Margin="0,0,6,0" VerticalAlignment="Center" />
            <TextBlock Text="未完成" Foreground="#FB8C00" />
            <TextBlock Text="{Binding TaskList.Statistics.Incomplete}" FontWeight="SemiBold" Margin="6,0,14,0" />
          </StackPanel>
          <StackPanel Orientation="Horizontal">
            <Ellipse Width="8" Height="8" Fill="#43A047" Margin="0,0,6,0" VerticalAlignment="Center" />
            <TextBlock Text="已完成" Foreground="#43A047" />
            <TextBlock Text="{Binding TaskList.Statistics.Completed}" FontWeight="SemiBold" Margin="6,0,0,0" />
          </StackPanel>
        </StackPanel>
      </Border>

      <Border Background="White" CornerRadius="12" Padding="12" Grid.Row="2" Margin="0,12,0,0"
              BorderBrush="#E6E9F0" BorderThickness="1">
        <StackPanel>
          <StackPanel Orientation="Horizontal">
            <ComboBox Width="140"
                      ItemsSource="{Binding TaskList.FilterOptions}"
                      DisplayMemberPath="Label"
                      SelectedValuePath="Value"
                      SelectedValue="{Binding TaskList.SelectedFilter, Mode=TwoWay}"
                      materialDesign:HintAssist.Hint="筛选" />
            <ComboBox Width="160" Margin="8,0,0,0"
                      ItemsSource="{Binding TaskList.SortOptions}"
                      DisplayMemberPath="Label"
                      SelectedValuePath="Value"
                      SelectedValue="{Binding TaskList.SelectedSort, Mode=TwoWay}"
                      materialDesign:HintAssist.Hint="排序" />
            <Button Style="{StaticResource MaterialDesignOutlinedButton}" Margin="8,0,0,0"
                    Command="{Binding TaskList.RefreshCommand}">
              <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="Refresh" Width="16" Height="16" Margin="0,0,6,0" />
                <TextBlock Text="刷新" />
              </StackPanel>
            </Button>
          </StackPanel>
          <DockPanel Margin="0,10,0,0">
            <TextBox Text="{Binding TaskList.SearchKeyword, UpdateSourceTrigger=PropertyChanged}"
                     materialDesign:HintAssist.Hint="搜索任务"
                     DockPanel.Dock="Left" />
            <Button Style="{StaticResource MaterialDesignFlatButton}" Margin="8,0,0,0"
                    Command="{Binding TaskList.ClearSearchCommand}">
              <TextBlock Text="清空" />
            </Button>
          </DockPanel>
        </StackPanel>
      </Border>

      <Border Background="White" CornerRadius="12" Padding="4" Grid.Row="3" Margin="0,12,0,0"
              BorderBrush="#E6E9F0" BorderThickness="1">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>

          <ProgressBar Grid.Row="0" Height="4" IsIndeterminate="True"
                       Visibility="{Binding TaskList.IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />
          <TextBlock Grid.Row="1" Text="{Binding TaskList.Error}" Foreground="#C62828" Margin="12,8,12,0"
                     Visibility="{Binding TaskList.Error, Converter={StaticResource StringNotEmptyToVisibilityConverter}}" />

          <ListView Grid.Row="2" ItemsSource="{Binding TaskList.Tasks}" Margin="0,8,0,0"
                    Background="Transparent" BorderThickness="0">
            <ListView.ItemTemplate>
              <DataTemplate>
                <Border CornerRadius="12" Padding="14" Margin="12,6"
                        Background="White"
                        BorderBrush="#E5E8F0" BorderThickness="1"
                        materialDesign:ShadowAssist.ShadowDepth="Depth1">
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <CheckBox Grid.Column="0" IsChecked="{Binding IsCompleted}" VerticalAlignment="Top" Margin="0,2,12,0" />

                    <StackPanel Grid.Column="1">
                      <Grid>
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="{Binding Title}" FontSize="14" FontWeight="SemiBold" TextWrapping="Wrap">
                          <TextBlock.Style>
                            <Style TargetType="TextBlock">
                              <Setter Property="TextDecorations" Value="{x:Null}" />
                              <Setter Property="Foreground" Value="#1F2937" />
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                                  <Setter Property="TextDecorations" Value="Strikethrough" />
                                  <Setter Property="Foreground" Value="#9AA1AE" />
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </TextBlock.Style>
                        </TextBlock>
                        <Ellipse Grid.Column="1" Width="8" Height="8" Margin="8,6,0,0"
                                 Fill="{Binding Priority, Converter={StaticResource PriorityToBrushConverter}}">
                          <Ellipse.Style>
                            <Style TargetType="Ellipse">
                              <Setter Property="Opacity" Value="1" />
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding IsRead}" Value="True">
                                  <Setter Property="Opacity" Value="0" />
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </Ellipse.Style>
                        </Ellipse>
                      </Grid>

                      <TextBlock Text="{Binding Description}" Foreground="#6B7280" TextWrapping="Wrap" Margin="0,6,0,0" MaxHeight="42"
                                 Visibility="{Binding Description, Converter={StaticResource StringNotEmptyToVisibilityConverter}}" />

                      <WrapPanel Margin="0,8,0,0">
                        <materialDesign:Chip Content="{Binding DueDate, StringFormat=截止 {0:MM-dd HH:mm}}"
                                             Margin="0,0,6,6">
                          <materialDesign:Chip.Style>
                            <Style TargetType="materialDesign:Chip">
                              <Setter Property="Visibility" Value="Visible" />
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding DueDate}" Value="{x:Null}">
                                  <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </materialDesign:Chip.Style>
                        </materialDesign:Chip>
                        <materialDesign:Chip Content="{Binding Tags}" Margin="0,0,6,6">
                          <materialDesign:Chip.Style>
                            <Style TargetType="materialDesign:Chip">
                              <Setter Property="Visibility" Value="Visible" />
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding Tags}" Value="{x:Null}">
                                  <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Tags}" Value="">
                                  <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </materialDesign:Chip.Style>
                        </materialDesign:Chip>
                        <materialDesign:Chip Content="AI 创建" Background="#E3F2FD" Margin="0,0,6,6">
                          <materialDesign:Chip.Style>
                            <Style TargetType="materialDesign:Chip">
                              <Setter Property="Visibility" Value="Collapsed" />
                              <Style.Triggers>
                                <DataTrigger Binding="{Binding Source}" Value="{x:Static coreEnums:TaskSource.Ai}">
                                  <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                              </Style.Triggers>
                            </Style>
                          </materialDesign:Chip.Style>
                        </materialDesign:Chip>
                      </WrapPanel>
                    </StackPanel>

                    <StackPanel Grid.Column="2" VerticalAlignment="Center" Margin="12,0,0,0">
                      <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                              Command="{Binding DataContext.TaskList.OpenDetailCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                              CommandParameter="{Binding}" Margin="0,0,0,6">
                        <TextBlock Text="详情" />
                      </Button>
                      <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                              Command="{Binding DataContext.TaskList.OpenEditCommand, RelativeSource={RelativeSource AncestorType=ListView}}"
                              CommandParameter="{Binding}">
                        <TextBlock Text="编辑" />
                      </Button>
                    </StackPanel>
                  </Grid>
                </Border>
              </DataTemplate>
            </ListView.ItemTemplate>
          </ListView>
        </Grid>
      </Border>
    </Grid>

    <!-- AI 对话 -->
    <Grid Grid.Column="1" Margin="12,0,0,0">
      <!-- 对话区 -->
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="White" CornerRadius="12" Padding="12"
                BorderBrush="#E6E9F0" BorderThickness="1">
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" Style="{StaticResource MaterialDesignOutlinedButton}" Padding="12,8"
                    HorizontalContentAlignment="Stretch">
              <Button.ContextMenu>
                <ContextMenu>
                  <ContextMenu.Resources>
                    <DataTemplate DataType="{x:Type coreModels:Conversation}">
                      <Grid Margin="0,2">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="*" />
                          <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <StackPanel>
                          <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                          <TextBlock Text="{Binding LastMessageContent}" FontSize="11" Foreground="#7A808A"
                                     Visibility="{Binding LastMessageContent, Converter={StaticResource StringNotEmptyToVisibilityConverter}}" />
                        </StackPanel>
                        <Button Grid.Column="1" Style="{StaticResource MaterialDesignFlatButton}" Padding="4"
                                Command="{Binding DataContext.Chat.DeleteConversationByIdCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                CommandParameter="{Binding}">
                          <materialDesign:PackIcon Kind="DeleteOutline" Width="16" Height="16" />
                        </Button>
                      </Grid>
                    </DataTemplate>
                  </ContextMenu.Resources>
                  <ContextMenu.ItemsSource>
                    <scm:CompositeCollection>
                      <MenuItem Header="新会话" Command="{Binding Chat.NewConversationCommand}" />
                      <Separator />
                      <scm:CollectionContainer Collection="{Binding Chat.Conversations}" />
                    </scm:CompositeCollection>
                  </ContextMenu.ItemsSource>
                  <ContextMenu.ItemContainerStyle>
                    <Style TargetType="MenuItem">
                      <Setter Property="Command"
                              Value="{Binding DataContext.Chat.SelectConversationCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                      <Setter Property="CommandParameter" Value="{Binding}" />
                    </Style>
                  </ContextMenu.ItemContainerStyle>
                </ContextMenu>
              </Button.ContextMenu>
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <StackPanel>
                  <TextBlock Text="{Binding Chat.CurrentConversationTitle}" FontWeight="SemiBold" />
                  <TextBlock Text="{Binding Chat.CurrentConversationSubtitle}" Foreground="#7A808A" FontSize="11"
                             Visibility="{Binding Chat.CurrentConversationSubtitle, Converter={StaticResource StringNotEmptyToVisibilityConverter}}" />
                </StackPanel>
                <materialDesign:PackIcon Kind="MenuDown" Width="18" Height="18" Foreground="#6B7280"
                                         Grid.Column="1" Margin="8,0,0,0" VerticalAlignment="Center" />
              </Grid>
            </Button>

            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="12,0,0,0">
              <Border Background="#EEF1FF" CornerRadius="10" Padding="2">
                <StackPanel Orientation="Horizontal">
                  <ToggleButton Content="芯服务" Style="{StaticResource AssistantToggleButtonStyle}"
                                IsChecked="{Binding Chat.IsXinServiceSelected, Mode=TwoWay}" />
                  <ToggleButton Content="本地问答" Style="{StaticResource AssistantToggleButtonStyle}" Margin="6,0,0,0"
                                IsChecked="{Binding Chat.IsLocalQaSelected, Mode=TwoWay}" />
                </StackPanel>
              </Border>
              <StackPanel Orientation="Horizontal" Margin="12,0,0,0" VerticalAlignment="Center">
                <TextBlock Text="AI 正在输出..." Foreground="#5C6BC0"
                           Visibility="{Binding Chat.IsStreaming, Converter={StaticResource BooleanToVisibilityConverter}}" />
                <TextBlock Text="{Binding Chat.Error}" Foreground="#C62828" Margin="12,0,0,0"
                           Visibility="{Binding Chat.Error, Converter={StaticResource StringNotEmptyToVisibilityConverter}}" />
              </StackPanel>
            </StackPanel>
          </Grid>
        </Border>

        <ListBox Grid.Row="1" ItemsSource="{Binding Chat.Messages}" Background="Transparent" BorderThickness="0" Margin="0,12,0,12">
          <ListBox.ItemTemplate>
            <DataTemplate>
              <Grid Margin="0,6">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto" />
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Border x:Name="LeftAvatar" Width="36" Height="36" CornerRadius="18"
                        Background="#E8EAF6" VerticalAlignment="Top" Margin="0,4,8,0">
                  <TextBlock Text="AI" FontWeight="SemiBold" Foreground="#5C6BC0"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Border>

                <Border x:Name="Bubble" Grid.Column="1" Padding="12" CornerRadius="12"
                        Background="White" BorderBrush="#E5E8F0" BorderThickness="1"
                        MaxWidth="560">
                  <StackPanel>
                    <TextBlock Text="{Binding RoleLabel}" Foreground="#8A9099" FontSize="11" />
                    <md:MarkdownViewer Markdown="{Binding Content}" Background="Transparent" />
                  </StackPanel>
                </Border>

                <Border x:Name="RightAvatar" Grid.Column="2" Width="36" Height="36" CornerRadius="18"
                        Background="#E3F2FD" VerticalAlignment="Top" Margin="8,4,0,0">
                  <TextBlock Text="我" FontWeight="SemiBold" Foreground="#1E88E5"
                             HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Border>
              </Grid>
              <DataTemplate.Triggers>
                <DataTrigger Binding="{Binding IsUser}" Value="True">
                  <Setter TargetName="LeftAvatar" Property="Visibility" Value="Collapsed" />
                  <Setter TargetName="RightAvatar" Property="Visibility" Value="Visible" />
                  <Setter TargetName="Bubble" Property="HorizontalAlignment" Value="Right" />
                  <Setter TargetName="Bubble" Property="Background" Value="#E3F2FD" />
                  <Setter TargetName="Bubble" Property="BorderBrush" Value="#BBDEFB" />
                </DataTrigger>
                <DataTrigger Binding="{Binding IsUser}" Value="False">
                  <Setter TargetName="LeftAvatar" Property="Visibility" Value="Visible" />
                  <Setter TargetName="RightAvatar" Property="Visibility" Value="Collapsed" />
                </DataTrigger>
              </DataTemplate.Triggers>
            </DataTemplate>
          </ListBox.ItemTemplate>
        </ListBox>

        <Border Grid.Row="2" Background="White" CornerRadius="12" Padding="12"
                BorderBrush="#E6E9F0" BorderThickness="1">
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <TextBox Grid.Column="0" Height="64"
                     Text="{Binding Chat.InputText, UpdateSourceTrigger=PropertyChanged}"
                     AcceptsReturn="True" TextWrapping="Wrap"
                     materialDesign:HintAssist.Hint="输入消息... (Enter发送，Shift+Enter换行)" />
            <Button Grid.Column="1" Style="{StaticResource MaterialDesignRaisedButton}" Margin="12,0,0,0"
                    Command="{Binding Chat.SendCommand}" Padding="12,8">
              <StackPanel Orientation="Horizontal">
                <materialDesign:PackIcon Kind="Send" Width="16" Height="16" Margin="0,0,6,0" />
                <TextBlock Text="发送" />
              </StackPanel>
            </Button>
          </Grid>
        </Border>
      </Grid>
    </Grid>
  </Grid>
</Window>
